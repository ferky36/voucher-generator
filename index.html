<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com https://cdn.skypack.dev https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net; worker-src 'self' blob: https://cdn.jsdelivr.net; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none'">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>Voucher System – User</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  
  <style>
    :root{--accent:#2f80ed;--ok:#10b981;--warn:#f59e0b;--bg:#0b0d12;--card:#121722;--text:#e6edf5;--muted:#9aa7b2;}
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{padding:18px 16px;border-bottom:1px solid #1f2937;display:flex;gap:12px;align-items:center;justify-content:space-between}
    a{color:#a5d8ff}
    h1{font-size:18px;margin:0}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #232b3a;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;margin:6px 0 6px;color:var(--muted)}
    input[type=file],input[type=text],input[type=email],input[type=password],button{background:#0f131b;border:1px solid #263043;color:#e6edf5;padding:10px;border-radius:10px}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:white}
    button.ghost{background:transparent}
    .log{background:#0f131b;border:1px dashed #2a3446;border-radius:10px;padding:10px;white-space:pre-wrap;max-height:220px;overflow:auto}
    .codes{font-family:ui-monospace,Menlo,Consolas,monospace}
    .hidden{display:none}
    .badge{padding:.15rem .46rem;border-radius:999px;font-size:12px;border:1px solid #334155;color:#cbd5e1}
    .success{color:#d1fae5;border-color:#065f46;background:#064e3b52}
    .warn{color:#ffe5b4;border-color:#b45309;background:#713f1266}
    .sliderWrap{padding:14px;background:#0f131b;border:1px solid #263043;border-radius:14px}
    .sliderWrap input[type=range]{width:100%}
    .big{font-size:28px;letter-spacing:1px}
    .center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
    .loading{gap:8px;align-items:center}
    .loading:before{content:"";width:14px;height:14px;border:2px solid #cbd5e1;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* --- AUTH GATING --- */
    .auth .auth-only { display: none !important; }
    .unauth .authed-only { display: none !important; }
    /* optional: cegah FOUC saat load */
    .authed-only { visibility: hidden; }
    .auth .authed-only { visibility: visible; }

  
    .inputWrap{display:flex;align-items:center;gap:8px;flex-wrap:nowrap}
    .domainTag{display:inline-flex;align-items:center;border:1px solid #263043;background:#0f131b;color:#9aa7b2;border-radius:10px;padding:10px 12px;white-space:nowrap}
    @media (max-width:520px){ .inputWrap{flex-wrap:wrap} }

    /* ---- UI Polish / Redesign (overrides) ---- */
    .card{border-radius:16px;border-color:#273246;background:linear-gradient(180deg,#121722 0%,#101520 100%);box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .card:hover{box-shadow:0 10px 28px rgba(0,0,0,.42)}
    header{backdrop-filter:saturate(1.1) blur(2px);background:#0b0d12d9;border-bottom-color:#1c2533}
    button{border-radius:12px;padding:10px 14px;transition:all .15s ease;border:1px solid #2b3850}
    button.primary{background:linear-gradient(180deg,var(--accent),#1e66d0);box-shadow:0 6px 16px rgba(47,128,237,.35)}
    button.primary:hover{filter:brightness(1.05)}
    button.ghost{background:transparent;border-color:#2b3850}
    button.ghost:hover{background:#182233}
    input[type=text],input[type=email],input[type=password],input[type=number]{border-radius:12px;padding:10px 12px;border:1px solid #2b3850;outline:none}
    input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .log{background:#0e141e;border:1px dashed #2a3650;border-radius:12px}
    .codes{font-variant-ligatures:none;line-height:1.45}
    /* badges */
    .badge{display:inline-flex;align-items:center;gap:8px;padding:.35rem .7rem;border-radius:9999px;border:1px solid #31415e;background:#0f1522;color:#cbd5e1;font-size:12.5px;line-height:1;box-shadow:inset 0 1px 0 rgba(255,255,255,.03)}
    .badge.user::before{content:"";width:14px;height:14px;display:inline-block;background:url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"%23cbd5e1\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"/><circle cx=\"12\" cy=\"7\" r=\"4\"/></svg>') center/contain no-repeat}
    .badge.success{color:#d1fae5;border-color:#065f46;background:#064e3b88}
    .badge.warn{color:#ffe2b8;border-color:#b45309;background:#713f1288}
    /* slider */
    input[type=range]{appearance:none;height:10px;border-radius:999px;background:linear-gradient(90deg,#2f4b7a,#2b3440);outline:none}
    input[type=range]::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:#3b82f6;border:2px solid #97b9ff;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:#3b82f6;border:2px solid #97b9ff;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    /* header right area */
    #whoUser{max-width:60vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  
  </style>
  <script>
    // Light theme variables (injected early so flicker is minimal)
    (function(){
      const css = document.createElement('style');
      css.textContent = `
      :root[data-theme="light"]{--bg:#f7fafc;--card:#ffffff;--text:#0f172a;--muted:#4b5563}
      :root[data-theme="light"] body{background:var(--bg);color:var(--text)}
      :root[data-theme="light"] .card{border-color:#d6dde7;background:linear-gradient(180deg,#ffffff 0%,#f4f7fb 100%)}
      :root[data-theme="light"] .log{background:#fff;border-color:#d8e1ee}
      :root[data-theme="light"] .badge{background:#f1f5f9;border-color:#cbd5e1;color:#0f172a}
      :root[data-theme="light"] header{background:#ffffffd9;border-bottom-color:#e5e7eb}
      :root[data-theme="light"] input, :root[data-theme="light"] button.ghost{border-color:#cbd5e1;background:#fff;color:#0f172a}
      `;
      document.head.appendChild(css);
    })();
  </script>

</head>
<body class="unauth">
  <header>
    <h1>Voucher User — Generate & Slide</h1>
    <div class="row" style="gap:8px;align-items:center">
      <button id="btnTheme" class="ghost">Light Mode</button>
      <span id="whoUser" class="badge user authed-only"></span>
      <button id="btnLogout" class="ghost authed-only">Logout</button>
    </div>
  </header>
  <div class="container">
    <div class="card auth-only" id="userAuthBox" style="margin-bottom:12px;background:#0f131b">
      <h3 style="margin:0 0 8px">Login / Daftar (Email OTP)</h3>
        <div class="row">
          <div class="inputWrap">
            <input id="otpLocal" type="text" placeholder="username saja (mis. tester)" />
            <span class="domainTag">@dataon.com</span>
          </div>
          <button id="btnSendOtp" class="primary">Kirim Link OTP</button>
          <span id="otpStatus" class="badge hidden"></span>
        </div>
      <small class="badge">Cek email lalu klik link untuk kembali ke halaman ini.</small>
    </div>

    <div class="card center authed-only">
      <button id="btnGenerate" class="primary" style="min-width:220px">Generate Voucher</button>
      <div id="genLoading" class="loading hidden">Sedang generate kode…</div>

      <span id="genStatus" class="badge hidden"></span>

      <div id="claimWrap" class="hidden" style="width:100%">
        <p class="badge warn">Geser slider sampai penuh untuk <strong>menampilkan</strong> dan <strong>menggunakan</strong> voucher.</p>
        <div id="sliderWrap" class="sliderWrap">
          <input id="revealSlider" type="range" value="0" min="0" max="100" />
          <div class="row" style="justify-content:space-between;color:#9aa7b2">
            <span>Geser ▶</span>
            <span>100%</span>
          </div>
        </div>
        <div id="voucherShow" class="card hidden center" style="margin-top:12px;background:#0f131b">
          <div class="badge success">Voucher Anda</div>
          <div id="voucherCode" class="big codes">•••••-•••••</div>
          <button id="btnCopy" class="ghost">Copy</button>
        </div>
      </div>
      <div class="card authed-only" style="width:100%;background:#0f131b;margin-top:12px">
        <h3 style="margin:0 0 8px">Voucher Saya</h3>
        <div class="row" style="justify-content:space-between">
          <span class="badge">Riwayat klaim</span>
          <span id="remainClaims" class="badge"></span>
        </div>
        <div id="myVouchers" class="log codes" style="margin-top:8px;max-height:260px"></div>
      </div>
    </div>
  </div>

  <script type="module" src="./js/app.js"></script>
  <script type="module" src="./js/user.js"></script>
</body>
</html>
