<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com https://cdn.skypack.dev https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' https://*.supabase.co https://cdn.jsdelivr.net; worker-src 'self' blob: https://cdn.jsdelivr.net; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; object-src 'none'">
  <meta http-equiv="Referrer-Policy" content="no-referrer">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>Voucher System – Admin</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  
  <style>
    :root{--accent:#2f80ed;--ok:#10b981;--warn:#f59e0b;--bg:#0b0d12;--card:#121722;--text:#e6edf5;--muted:#9aa7b2;}
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{padding:18px 16px;border-bottom:1px solid #1f2937;display:flex;gap:12px;align-items:center;justify-content:space-between}
    a{color:#a5d8ff}
    h1{font-size:18px;margin:0}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #232b3a;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;margin:6px 0 6px;color:var(--muted)}
    input[type=file],input[type=text],input[type=email],input[type=password],button{background:#0f131b;border:1px solid #263043;color:#e6edf5;padding:10px;border-radius:10px}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:white}
    button.ghost{background:transparent}
    .log{background:#0f131b;border:1px dashed #2a3446;border-radius:10px;padding:10px;white-space:pre-wrap;max-height:220px;overflow:auto}
    .codes{font-family:ui-monospace,Menlo,Consolas,monospace}
    .hidden{display:none}
    .badge{padding:.15rem .46rem;border-radius:999px;font-size:12px;border:1px solid #334155;color:#cbd5e1}
    .success{color:#d1fae5;border-color:#065f46;background:#064e3b52}
    .warn{color:#ffe5b4;border-color:#b45309;background:#713f1266}
    .sliderWrap{padding:14px;background:#0f131b;border:1px solid #263043;border-radius:14px}
    .sliderWrap input[type=range]{width:100%}
    .big{font-size:28px;letter-spacing:1px}
    .center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px}
    .loading{display:inline-flex;gap:8px;align-items:center}
    .loading:before{content:"";width:14px;height:14px;border:2px solid #cbd5e1;border-top-color:transparent;border-radius:50%;display:inline-block;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-overlay:not(.hidden){display:flex}
    .modal{background:#121722;border:1px solid #232b3a;border-radius:12px;padding:16px;max-width:460px;width:92%;box-shadow:0 20px 40px rgba(0,0,0,.45)}
    .modal h3{margin:0 0 10px;font-size:16px}
    .modal .row{justify-content:flex-end}
    /* redesign overrides */
    .card{border-radius:16px;border-color:#273246;background:linear-gradient(180deg,#121722 0%,#101520 100%);box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .card:hover{box-shadow:0 10px 28px rgba(0,0,0,.42)}
    header{backdrop-filter:saturate(1.1) blur(2px);background:#0b0d12d9;border-bottom-color:#1c2533}
    button{border-radius:12px;padding:10px 14px;transition:all .15s ease;border:1px solid #2b3850}
    button.primary{background:linear-gradient(180deg,var(--accent),#1e66d0);box-shadow:0 6px 16px rgba(47,128,237,.35)}
    button.primary:hover{filter:brightness(1.05)}
    button.ghost{background:transparent;border-color:#2b3850}
    button.ghost:hover{background:#182233}
    input[type=text],input[type=email],input[type=password],input[type=number]{border-radius:12px;padding:10px 12px;border:1px solid #2b3850;outline:none}
    input:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .log{background:#0e141e;border:1px dashed #2a3650;border-radius:12px}
    .codes{font-variant-ligatures:none;line-height:1.45}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:.35rem .7rem;border-radius:9999px;border:1px solid #31415e;background:#0f1522;color:#cbd5e1;font-size:12.5px;line-height:1;box-shadow:inset 0 1px 0 rgba(255,255,255,.03)}
    .badge.success{color:#d1fae5;border-color:#065f46;background:#064e3b88}
    .badge.warn{color:#ffe2b8;border-color:#b45309;background:#713f1288}
    #whoAdmin{max-width:50vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    /* --- AUTH GATING --- */
    .auth .auth-only { display: none !important; }
    .unauth .authed-only { display: none !important; }
    /* optional: cegah FOUC saat load */
    .authed-only { visibility: hidden; }
    .auth .authed-only { visibility: visible; }

  </style>
  <script>
    (function(){
      const css = document.createElement('style');
      css.textContent = `
      :root[data-theme="light"]{--bg:#f7fafc;--card:#ffffff;--text:#0f172a;--muted:#4b5563}
      :root[data-theme="light"] body{background:var(--bg);color:var(--text)}
      :root[data-theme="light"] .card{border-color:#d6dde7;background:linear-gradient(180deg,#ffffff 0%,#f4f7fb 100%)}
      :root[data-theme="light"] .log{background:#fff;border-color:#d8e1ee}
      :root[data-theme="light"] .badge{background:#f1f5f9;border-color:#cbd5e1;color:#0f172a}
      :root[data-theme="light"] header{background:#ffffffd9;border-bottom-color:#e5e7eb}
      :root[data-theme="light"] input, :root[data-theme="light"] button.ghost{border-color:#cbd5e1;background:#fff;color:#0f172a}
      `;
      document.head.appendChild(css);
    })();
  </script>

</head>
<body class="unauth">
  <header>
    <h1>Voucher Admin — OCR & Import</h1>
    <a href="./index.html" class="badge">Ke halaman User →</a>
  </header>
  <div class="container">
    <div class="card auth-only" id="authBox" style="margin-bottom:12px;background:#0f131b">
      <h3 style="margin:0 0 8px">Login Admin</h3>
      <div class="row">
        <input id="email" type="email" placeholder="admin email" />
        <input id="password" type="password" placeholder="password" />
        <button id="btnLogin" class="primary">Login</button>
        <span id="authStatus" class="badge hidden"></span>
      </div>
  <!-- Hapus logout di dalam authBox karena card ini disembunyikan setelah login -->
  

    </div>

    <div class="card authed-only" id="roleCard" style="margin-bottom:12px;background:#0f131b">
      <h3 style="margin:0 0 8px">Role / Profiles</h3>
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="btnWhoAmI" class="ghost">Cek Role Saya</button>
          <button id="btnMakeMeAdmin" class="primary">Jadikan Saya ADMIN</button>
          <button id="btnLogoutAdmin" class="ghost">Logout</button>
        </div>
        <div class="row" style="gap:8px">
          <button id="btnTheme" class="ghost">Light Mode</button>
          <span id="whoAdmin" class="badge user authed-only"></span>
          <span id="roleStatus" class="badge hidden"></span>
        </div>
      </div>
    </div>

    <div class="card authed-only" id="settingsCard" style="margin-bottom:12px;background:#0f131b">
      <h3 style="margin:0 0 8px">Pengaturan Klaim</h3>
      <div class="row" style="align-items:center">
        <label style="margin:0">Max voucher per user (lifetime)</label>
        <input id="maxClaims" type="number" min="0" step="1" placeholder="mis. 5" style="width:120px" />
        <button id="btnSaveMaxClaims" class="primary">Simpan</button>
        <span id="maxClaimsStatus" class="badge hidden"></span>
      </div>
      <small class="badge">0 atau kosong = tidak dibatasi</small>
    </div>

    <div class="card authed-only" id="adminMainCard">
      <label>Gambar voucher (bisa banyak)</label>
      <input id="imgFiles" type="file" multiple accept="image/*,application/pdf" />

      <div class="row" style="margin-top:10px">
        <button id="btnOcr" class="primary">Ekstrak dengan OCR</button>
        <button id="btnClear" class="ghost">Bersihkan hasil</button>
      </div>

      <label style="margin-top:12px">Hasil OCR (unik & tervalidasi pola 5-5 digit)</label>
      <div id="ocrOut" class="log codes">—</div>

      <div class="row" style="margin-top:10px">
        <button id="btnImport" class="primary">Import Kode Voucher</button>
        <label class="inline-flex items-center gap-2 ml-3 text-sm">
          <input type="checkbox" id="chkReset">
          Hapus semua voucher sebelum import
        </label>
        <span id="importStatus" class="badge hidden"></span>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnRlsDiag" class="ghost">Diagnose RLS (vouchers)</button>
        <span class="badge">Cek policy aktif & sesi</span>
      </div>
      <div id="diagOut" class="log codes hidden"></div>
  </div>
  </div>

  <!-- Modal password admin -->
  <div id="adminPwdModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Konfirmasi Admin</h3>
      <p>Masukkan password akun untuk konfirmasi jadi ADMIN:</p>
      <input id="adminPwdInput" type="password" placeholder="Password" style="width:100%;margin:8px 0" />
      <div class="row">
        <button id="btnAdminPwdCancel" class="ghost">Batal</button>
        <button id="btnAdminPwdOk" class="primary">OK</button>
      </div>
    </div>
  </div>


  <script type="module" src="./js/app.js"></script>
  <script type="module" src="./js/admin.js"></script>
</body>
</html>
